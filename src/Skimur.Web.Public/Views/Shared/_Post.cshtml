@using Skimur.Web.Services
@using Subs
@using Subs.ReadModel
@model PostWrapped
@{
    bool canMarkRead = false;
    if (ViewData.ContainsKey("CanMarkRead"))
    {
        canMarkRead = (bool)ViewData["CanMarkRead"];
    }
}

@*<div class="media">
        <div class="media-left">
            <a href="#">
                <img class="media-object" data-src="holder.js/64x64" alt="64x64" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9InllcyI/PjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+PCEtLQpTb3VyY2UgVVJMOiBob2xkZXIuanMvNjR4NjQKQ3JlYXRlZCB3aXRoIEhvbGRlci5qcyAyLjYuMC4KTGVhcm4gbW9yZSBhdCBodHRwOi8vaG9sZGVyanMuY29tCihjKSAyMDEyLTIwMTUgSXZhbiBNYWxvcGluc2t5IC0gaHR0cDovL2ltc2t5LmNvCi0tPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PCFbQ0RBVEFbI2hvbGRlcl8xNTBiZjQ3Yzg0NCB0ZXh0IHsgZmlsbDojQUFBQUFBO2ZvbnQtd2VpZ2h0OmJvbGQ7Zm9udC1mYW1pbHk6QXJpYWwsIEhlbHZldGljYSwgT3BlbiBTYW5zLCBzYW5zLXNlcmlmLCBtb25vc3BhY2U7Zm9udC1zaXplOjEwcHQgfSBdXT48L3N0eWxlPjwvZGVmcz48ZyBpZD0iaG9sZGVyXzE1MGJmNDdjODQ0Ij48cmVjdCB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIGZpbGw9IiNFRUVFRUUiLz48Zz48dGV4dCB4PSIxNC41IiB5PSIzNi41Ij42NHg2NDwvdGV4dD48L2c+PC9nPjwvc3ZnPg==" data-holder-rendered="true" style="width: 64px; height: 64px;">
            </a>
        </div>
        <div class="media-left">
            <a href="#">
                <img class="media-object" data-src="holder.js/64x64" alt="64x64" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9InllcyI/PjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+PCEtLQpTb3VyY2UgVVJMOiBob2xkZXIuanMvNjR4NjQKQ3JlYXRlZCB3aXRoIEhvbGRlci5qcyAyLjYuMC4KTGVhcm4gbW9yZSBhdCBodHRwOi8vaG9sZGVyanMuY29tCihjKSAyMDEyLTIwMTUgSXZhbiBNYWxvcGluc2t5IC0gaHR0cDovL2ltc2t5LmNvCi0tPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PCFbQ0RBVEFbI2hvbGRlcl8xNTBiZjQ3Yzg0NCB0ZXh0IHsgZmlsbDojQUFBQUFBO2ZvbnQtd2VpZ2h0OmJvbGQ7Zm9udC1mYW1pbHk6QXJpYWwsIEhlbHZldGljYSwgT3BlbiBTYW5zLCBzYW5zLXNlcmlmLCBtb25vc3BhY2U7Zm9udC1zaXplOjEwcHQgfSBdXT48L3N0eWxlPjwvZGVmcz48ZyBpZD0iaG9sZGVyXzE1MGJmNDdjODQ0Ij48cmVjdCB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIGZpbGw9IiNFRUVFRUUiLz48Zz48dGV4dCB4PSIxNC41IiB5PSIzNi41Ij42NHg2NDwvdGV4dD48L2c+PC9nPjwvc3ZnPg==" data-holder-rendered="true" style="width: 64px; height: 64px;">
            </a>
        </div>
        <div class="media-body">
            <h4 class="media-heading">Nested media heading</h4>
            <p>Cras sit amet nibh libero, in gravida nulla. Nulla vel metus scelerisque ante sollicitudin commodo. Cras purus odio, vestibulum in vulputate at, tempus viverra turpis.</p>
            <p>Cras sit amet nibh libero, in gravida nulla. Nulla vel metus scelerisque ante sollicitudin commodo. Cras purus odio, vestibulum in vulputate at, tempus viverra turpis.</p>
            <p>Cras sit amet nibh libero, in gravida nulla. Nulla vel metus scelerisque ante sollicitudin commodo. Cras purus odio, vestibulum in vulputate at, tempus viverra turpis.</p>
            <p>Cras sit amet nibh libero, in gravida nulla. Nulla vel metus scelerisque ante sollicitudin commodo. Cras purus odio, vestibulum in vulputate at, tempus viverra turpis.</p>

            <div class="media">
                <div class="media-left">
                    <a href="#">
                        <img class="media-object" data-src="holder.js/64x64" alt="64x64" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9InllcyI/PjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+PCEtLQpTb3VyY2UgVVJMOiBob2xkZXIuanMvNjR4NjQKQ3JlYXRlZCB3aXRoIEhvbGRlci5qcyAyLjYuMC4KTGVhcm4gbW9yZSBhdCBodHRwOi8vaG9sZGVyanMuY29tCihjKSAyMDEyLTIwMTUgSXZhbiBNYWxvcGluc2t5IC0gaHR0cDovL2ltc2t5LmNvCi0tPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PCFbQ0RBVEFbI2hvbGRlcl8xNTBiZjQ3Yzg0NCB0ZXh0IHsgZmlsbDojQUFBQUFBO2ZvbnQtd2VpZ2h0OmJvbGQ7Zm9udC1mYW1pbHk6QXJpYWwsIEhlbHZldGljYSwgT3BlbiBTYW5zLCBzYW5zLXNlcmlmLCBtb25vc3BhY2U7Zm9udC1zaXplOjEwcHQgfSBdXT48L3N0eWxlPjwvZGVmcz48ZyBpZD0iaG9sZGVyXzE1MGJmNDdjODQ0Ij48cmVjdCB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIGZpbGw9IiNFRUVFRUUiLz48Zz48dGV4dCB4PSIxNC41IiB5PSIzNi41Ij42NHg2NDwvdGV4dD48L2c+PC9nPjwvc3ZnPg==" data-holder-rendered="true" style="width: 64px; height: 64px;">
                    </a>
                </div>
                <div class="media-left">
                    <a href="#">
                        <img class="media-object" data-src="holder.js/64x64" alt="64x64" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9InllcyI/PjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+PCEtLQpTb3VyY2UgVVJMOiBob2xkZXIuanMvNjR4NjQKQ3JlYXRlZCB3aXRoIEhvbGRlci5qcyAyLjYuMC4KTGVhcm4gbW9yZSBhdCBodHRwOi8vaG9sZGVyanMuY29tCihjKSAyMDEyLTIwMTUgSXZhbiBNYWxvcGluc2t5IC0gaHR0cDovL2ltc2t5LmNvCi0tPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PCFbQ0RBVEFbI2hvbGRlcl8xNTBiZjQ3Yzg0NCB0ZXh0IHsgZmlsbDojQUFBQUFBO2ZvbnQtd2VpZ2h0OmJvbGQ7Zm9udC1mYW1pbHk6QXJpYWwsIEhlbHZldGljYSwgT3BlbiBTYW5zLCBzYW5zLXNlcmlmLCBtb25vc3BhY2U7Zm9udC1zaXplOjEwcHQgfSBdXT48L3N0eWxlPjwvZGVmcz48ZyBpZD0iaG9sZGVyXzE1MGJmNDdjODQ0Ij48cmVjdCB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIGZpbGw9IiNFRUVFRUUiLz48Zz48dGV4dCB4PSIxNC41IiB5PSIzNi41Ij42NHg2NDwvdGV4dD48L2c+PC9nPjwvc3ZnPg==" data-holder-rendered="true" style="width: 64px; height: 64px;">
                    </a>
                </div>
                <div class="media-body">
                    <h4 class="media-heading">Nested media heading</h4>
                    <p>Cras sit amet nibh libero, in gravida nulla. Nulla vel metus scelerisque ante sollicitudin commodo. Cras purus odio, vestibulum in vulputate at, tempus viverra turpis.</p>
                    <p>Cras sit amet nibh libero, in gravida nulla. Nulla vel metus scelerisque ante sollicitudin commodo. Cras purus odio, vestibulum in vulputate at, tempus viverra turpis.</p>
                    <p>Cras sit amet nibh libero, in gravida nulla. Nulla vel metus scelerisque ante sollicitudin commodo. Cras purus odio, vestibulum in vulputate at, tempus viverra turpis.</p>
                    <p>Cras sit amet nibh libero, in gravida nulla. Nulla vel metus scelerisque ante sollicitudin commodo. Cras purus odio, vestibulum in vulputate at, tempus viverra turpis.</p>
                </div>
            </div>

        </div>
    </div>*@

<div class="disc post @PostClasses(Model)" data-post-id="@Model.Post.Id">
    <div class="disc-body">
        <div class="disc-left">
            <div class="disc-voting @(Model.CurrentUserVote != null ? Model.CurrentUserVote == VoteType.Down ? "voted-down" : "voted-up" : "")">
                <span class="up login-required" onclick="return skimurui.posts.voteUp(this)"></span>
                <span class="votes">@(Model.Post.VoteUpCount - Model.Post.VoteDownCount)</span>
                <span class="down login-required" onclick="return skimurui.posts.voteDown(this)"></span>
            </div>
        </div>
        @if (Model.Post.PostType == PostType.Link)
        {
            if (!string.IsNullOrEmpty(Model.Post.Thumb))
            {
                <div class="disc-left thumb">
                    <a href="@PostUrl(Model)">
                        <img src="@Url.Thumbnail(Model.Post.Thumb, ThumbnailType.Post)">
                    </a>
                </div>
            }
            else
            {
                <div class="disc-left thumb-none">
                    <a href="@PostUrl(Model)"></a>
                </div>
            }
        }
        else
        {
            <div class="disc-left thumb-text">
                <a href="@PostUrl(Model)"></a>
            </div>
        }
        <div class="disc-main">

            <div class="disc-heading">
                @if (Model.Post.Sticky)
                {
                    <span class="sticky">Sticky</span>
                }
                <a class="link" href="@PostUrl(Model)">@Model.Post.Title</a>
                @if (Model.Verdict.HasValue)
                {
                    if (Model.Verdict == Verdict.ModApproved)
                    {
                        <span class="verdict approved"></span>
                    }
                    else if (Model.Verdict == Verdict.ModRemoved)
                    {
                        <span class="verdict removed"></span>
                    }
                    else
                    {
                        <span class="verdict none"></span>
                    }
                }
                @if (!string.IsNullOrEmpty(Model.Post.Mirrored))
                {
                    <span class="mirror @Model.Post.Mirrored.ToLower()" title="mirrored from @Model.Post.Mirrored"></span>
                }
                @(DomainLink(Model))
            </div>
            <div class="disc-expando" onclick="return skimurui.posts.expando(this);"></div>
            <div class="disc-tagline">
                Posted @Html.Age(Model.Post.DateCreated) ago by <a href="/user/@Model.Author.UserName">@Model.Author.UserName</a> to <a href="@Url.Sub(Model.Sub.Name)">/s/@Model.Sub.Name</a>
            </div>
            @if (Model.Post.PostType == PostType.Text)
            {
                <div class="disc-content">
                    @Html.Raw(Model.Post.ContentFormatted)
                </div>
                <textarea class="disc-content-unformatted hidden">@Html.Raw(Model.Post.Content)</textarea>
            }
            <ul class="disc-options">
                @if (Model.Post.Nsfw)
                {
                    <li class="nsfw">
                        <span class="nsfw">NSFW</span>
                    </li>
                }
                <li class="first comments">
                    <a href="@Url.Post(Model.Sub, Model.Post)">@(Model.Post.NumberOfComments > 0 ? (Model.Post.NumberOfComments == 1 ? "1 comment" : Model.Post.NumberOfComments + " comments") : "comment")</a>
                </li>
                @if (!Model.Post.Deleted)
                {
                    if (Model.CanDelete)
                    {
                        <li class="delete">
                            <a href="javascript:void(0);" onclick="return skimurui.posts.delete(this)">delete</a>
                        </li>
                    }
                    if (Model.CanEdit)
                    {
                        <li class="edit">
                            <a href="javascript:void(0);" onclick="return skimurui.posts.startEdit(this)">edit</a>
                        </li>
                    }
                    if (Model.CanManage)
                    {
                        <li class="remove">
                            <a href="javascript:void(0);" onclick="return skimurui.posts.remove(this)" class="delete">remove</a>
                        </li>
                        <li class="approve">
                            <a href="javascript:void(0);" onclick="return skimurui.posts.approve(this)" class="delete">approve</a>
                        </li>
                    }
                    if (Model.CanReport)
                    {
                        <li class="report">
                            <a href="javascript:void(0);" onclick="return skimurui.posts.report(this);">report</a>
                        </li>
                    }
                    if (Model.CanManage)
                    {
                        if (Model.Reports != null && Model.Reports.Count > 0)
                        {
                            <li class="reports">
                                <a href="javascript:void(0);" onclick="return skimurui.posts.toggleReports(this);">reports (@Model.Reports.Count)</a>
                            </li>
                            <li class="clear-reports">
                                <a href="javascript:void(0);" onclick="return skimurui.posts.clearReports(this);">clear reports</a>
                            </li>
                        }
                        <li class="ignore-reports">
                            <a href="javascript:void(0);" onclick="return skimurui.posts.ignoreReports(this);">ignore reports</a>
                        </li>
                        <li class="unignore-reports">
                            <a href="javascript:void(0);" onclick="return skimurui.posts.unignoreReports(this);">unignore reports</a>
                        </li>
                        <li class="toggle-nsfw">
                            <a href="javascript:void(0);" onclick="return skimurui.posts.toggleNsfw(this);"><span class="mark-sfw">mark sfw</span><span class="mark-nsfw">mark nsfw</span></a>
                        </li>
                    }
                    if (Model.CanSticky)
                    {
                        <li class="toggle-sticky">
                            <a href="javascript:void(0);" onclick="return skimurui.posts.toggleSticky(this);">toggle sticky</a>
                        </li>
                    }
                }
                @if (canMarkRead)
                {
                    <li class="mark-unread">
                        <a href="javascript:void(0);" onclick="return skimurui.messages.markAsUnread(this)" class="reply">mark unread</a>
                    </li>
                    <li class="mark-read">
                        <a href="javascript:void(0);" onclick="return skimurui.messages.markAsRead(this)" class="reply">mark read</a>
                    </li>
                }
            </ul>
            @if (Model.CanManage && Model.Reports != null && Model.Reports.Count > 0)
            {
                <div class="disc-reports hidden">
                    @foreach (var report in Model.Reports)
                    {
                        <div class="report-summary">
                            <b>Reports:</b><br />
                            @report.Reason&nbsp;
                            @if (!string.IsNullOrEmpty(report.UserName))
                            {
                                <text>(reported by <a href="@Url.User(report.UserName)">@report.UserName</a>)</text>
                            }
                        </div>
                    }
                </div>
            }
            <div class="disc-staging"></div>
        </div>
    </div>
</div>

@helper PostClasses(PostWrapped post)
{
if (post.Verdict.HasValue)
{
    if (post.Verdict == Verdict.ModApproved)
    {
            @(" approved")
    }
    else if (post.Verdict == Verdict.ModRemoved)
    {
            @(" removed")
    }
}
if (post.CanDelete && post.Post.Deleted)
{
        @(" deleted")
}
if (post.CanManage)
{
        @(post.Post.IgnoreReports ? "reports-ignored" : "reports-unignored")
}
if (post.Post.Nsfw)
{
        @(" nsfw")
}
if (post.Post.Sticky)
{
        @(" sticky")
}
}

@helper DomainLink(PostWrapped post)
{
if (post.Post.PostType == PostType.Link)
{
    if (!string.IsNullOrEmpty(post.Post.Domain))
    {
            <a class="domain" href="@Url.Domain(post.Post.Domain)">(@post.Post.Domain)</a>
    }
}
else if (post.Post.PostType == PostType.Text)
{
        <a class="domain" href="@Url.Post(Model.Sub, Model.Post)">(self.@post.Sub.Name)</a>
}
}
@helper PostUrl(PostWrapped post)
{
if (post.Post.PostType == PostType.Link)
{
        @post.Post.Url
}
else if (post.Post.PostType == PostType.Text)
{
        @Url.Post(post.Sub, post.Post)
}
}